import { useMemo, useState } from "react";

export default function CalculadoraAntecipacaoClinipay() {
  // ======= Tabelas de Taxas =======
  const taxasStandard = [
    { parcelas: 1,  label: "√Ä vista", mdr: 0.0239, ant: 0.0199 },
    { parcelas: 2,  label: "2x",    mdr: 0.0299, ant: 0.0296 },
    { parcelas: 3,  label: "3x",    mdr: 0.0299, ant: 0.0394 },
    { parcelas: 4,  label: "4x",    mdr: 0.0299, ant: 0.0493 },
    { parcelas: 5,  label: "5x",    mdr: 0.0299, ant: 0.0591 },
    { parcelas: 6,  label: "6x",    mdr: 0.0299, ant: 0.0690 },
    { parcelas: 7,  label: "7x",    mdr: 0.0349, ant: 0.0788 },
    { parcelas: 8,  label: "8x",    mdr: 0.0349, ant: 0.0887 },
    { parcelas: 9,  label: "9x",    mdr: 0.0349, ant: 0.0986 },
    { parcelas: 10, label: "10x",   mdr: 0.0349, ant: 0.1084 },
    { parcelas: 11, label: "11x",   mdr: 0.0349, ant: 0.1183 },
    { parcelas: 12, label: "12x",   mdr: 0.0349, ant: 0.1281 },
    { parcelas: 13, label: "13x",   mdr: 0.0399, ant: 0.1380 },
    { parcelas: 14, label: "14x",   mdr: 0.0399, ant: 0.1478 },
    { parcelas: 15, label: "15x",   mdr: 0.0399, ant: 0.1577 },
    { parcelas: 16, label: "16x",   mdr: 0.0399, ant: 0.1675 },
    { parcelas: 17, label: "17x",   mdr: 0.0399, ant: 0.1774 },
    { parcelas: 18, label: "18x",   mdr: 0.0399, ant: 0.1873 },
    { parcelas: 19, label: "19x",   mdr: 0.0399, ant: 0.1971 },
    { parcelas: 20, label: "20x",   mdr: 0.0399, ant: 0.2070 },
    { parcelas: 21, label: "21x",   mdr: 0.0399, ant: 0.2168 },
  ];

  const taxasPremium = [
    { parcelas: 1,  label: "√Ä vista", mdr: 0.0199, ant: 0.0169 },
    { parcelas: 2,  label: "2x",    mdr: 0.0239, ant: 0.0251 },
    { parcelas: 3,  label: "3x",    mdr: 0.0239, ant: 0.0335 },
    { parcelas: 4,  label: "4x",    mdr: 0.0239, ant: 0.0419 },
    { parcelas: 5,  label: "5x",    mdr: 0.0239, ant: 0.0503 },
    { parcelas: 6,  label: "6x",    mdr: 0.0239, ant: 0.0587 },
    { parcelas: 7,  label: "7x",    mdr: 0.0299, ant: 0.0671 },
    { parcelas: 8,  label: "8x",    mdr: 0.0299, ant: 0.0754 },
    { parcelas: 9,  label: "9x",    mdr: 0.0299, ant: 0.0838 },
    { parcelas: 10, label: "10x",   mdr: 0.0299, ant: 0.0922 },
    { parcelas: 11, label: "11x",   mdr: 0.0299, ant: 0.1006 },
    { parcelas: 12, label: "12x",   mdr: 0.0299, ant: 0.1090 },
    { parcelas: 13, label: "13x",   mdr: 0.0349, ant: 0.1173 },
    { parcelas: 14, label: "14x",   mdr: 0.0349, ant: 0.1257 },
    { parcelas: 15, label: "15x",   mdr: 0.0349, ant: 0.1341 },
    { parcelas: 16, label: "16x",   mdr: 0.0349, ant: 0.1425 },
    { parcelas: 17, label: "17x",   mdr: 0.0349, ant: 0.1509 },
    { parcelas: 18, label: "18x",   mdr: 0.0349, ant: 0.1593 },
    { parcelas: 19, label: "19x",   mdr: 0.0349, ant: 0.1676 },
    { parcelas: 20, label: "20x",   mdr: 0.0349, ant: 0.1760 },
    { parcelas: 21, label: "21x",   mdr: 0.0349, ant: 0.1844 },
  ];

  const [valorVenda, setValorVenda] = useState(20000);
  const [parcelas, setParcelas] = useState(10);
  const [mostrarTabela, setMostrarTabela] = useState(false);

  const currency = new Intl.NumberFormat("pt-BR", {
    style: "currency",
    currency: "BRL",
    maximumFractionDigits: 2,
  });

  function calcular(planData: typeof taxasStandard) {
    const idx = Math.min(Math.max(parcelas, 1), 21) - 1;
    const item = planData[idx];
    const mdrValor = valorVenda * item.mdr;
    const baseAnt = valorVenda - mdrValor;
    const antValor = baseAnt * item.ant;
    const taxaTotal = mdrValor + antValor;
    const liquido = valorVenda - taxaTotal;

    return {
      item,
      taxaTotal,
      liquido,
      mdrValor,
      antValor,
      efetivaSobreBruto: taxaTotal / valorVenda, // taxa total em % do bruto
    };
  }

  const resultadoStandard = useMemo(() => calcular(taxasStandard), [valorVenda, parcelas]);
  const resultadoPremium = useMemo(() => calcular(taxasPremium), [valorVenda, parcelas]);

  const economiaPremium = useMemo(
    () => resultadoStandard.taxaTotal - resultadoPremium.taxaTotal,
    [resultadoStandard, resultadoPremium]
  );

  const linhaResumo = (titulo: string, r: ReturnType<typeof calcular>) => (
    <div className="rounded-2xl border border-gray-200 p-6 shadow-sm hover:shadow-md transition-shadow duration-200 bg-white">
      <h3 className="text-lg font-semibold mb-3 text-gray-900">{titulo}</h3>
      <p className="text-sm text-gray-600 mb-4">Plano: {r.item.label} ({parcelas} parcela{parcelas>1?"s":""})</p>
      <div className="grid grid-cols-2 gap-4">
        <div className="bg-gray-50 rounded-lg p-3 col-span-2">
          <p className="text-xs text-gray-500 uppercase tracking-wide font-medium">Taxa de Antecipa√ß√£o</p>
          <p className="font-semibold text-gray-900 mt-1">{currency.format(r.taxaTotal)}</p>
          <p className="text-xs text-gray-500">({(r.efetivaSobreBruto*100).toFixed(2)}%)</p>
        </div>
        <div className="bg-green-50 rounded-lg p-3 border border-green-100">
          <p className="text-xs text-green-600 uppercase tracking-wide font-medium col-span-2">L√≠quido</p>
          <p className="font-bold text-green-700 mt-1">{currency.format(r.liquido)}</p>
        </div>
      </div>
    </div>
  );

  const tabelaPlan = (titulo: string, planData: typeof taxasStandard) => (
    <div className="mt-8">
      <h4 className="font-semibold mb-4 text-gray-900 flex items-center">
        <span className="w-3 h-3 rounded-full bg-orange-500 mr-2"></span>
        {titulo} ‚Äî tabela completa
      </h4>
      <div className="overflow-hidden rounded-xl border border-gray-200 shadow-sm">
        <table className="min-w-full">
          <thead className="bg-gradient-to-r from-gray-50 to-gray-100">
            <tr>
              <th className="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wide">Parcelas</th>
              <th className="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wide">MDR</th>
              <th className="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wide">Antecip.</th>
              <th className="px-4 py-3 text-right text-xs font-medium text-gray-600 uppercase tracking-wide">Taxa Total</th>
              <th className="px-4 py-3 text-right text-xs font-medium text-gray-600 uppercase tracking-wide">L√≠quido</th>
            </tr>
          </thead>
          <tbody className="bg-white divide-y divide-gray-100">
            {planData.map((it, index) => {
              const mdrValor = valorVenda * it.mdr;
              const antValor = (valorVenda - mdrValor) * it.ant;
              const taxaTotal = mdrValor + antValor;
              const liquido = valorVenda - taxaTotal;
              const isSelected = it.parcelas === parcelas;
              return (
                <tr 
                  key={`${titulo}-${it.parcelas}`} 
                  className={`transition-colors duration-150 ${
                    isSelected 
                      ? 'bg-orange-50 border-l-4 border-l-orange-500' 
                      : index % 2 === 0 ? 'bg-white hover:bg-gray-50' : 'bg-gray-50 hover:bg-gray-100'
                  }`}
                >
                  <td className={`px-4 py-3 ${isSelected ? 'font-semibold text-orange-900' : 'text-gray-900'}`}>
                    {it.label}
                  </td>
                  <td className="px-4 py-3 text-gray-700 font-mono text-sm">{(it.mdr*100).toFixed(2)}%</td>
                  <td className="px-4 py-3 text-gray-700 font-mono text-sm">{(it.ant*100).toFixed(2)}%</td>
                  <td className="px-4 py-3 text-right font-semibold text-red-600">{currency.format(taxaTotal)}</td>
                  <td className="px-4 py-3 text-right font-semibold text-green-600">{currency.format(liquido)}</td>
                </tr>
              );
            })}
          </tbody>
        </table>
      </div>
    </div>
  );

  return (
    <div className="min-h-screen bg-white py-8">
      <div className="mx-auto max-w-6xl p-6">
        <div className="text-center mb-8">
          <h1 className="text-4xl font-bold text-gray-900 mb-2">Calculadora Antecipa√ß√£o Clinipay</h1>
          <p className="text-lg text-gray-600">Simula√ß√£o completa de venda + Antecipa√ß√£o (D+1)</p>
          <p className="text-sm text-gray-500 mt-1">Compare planos Standard vs Premium e otimize seus custos</p>
        </div>

        <div className="grid grid-cols-1 gap-6 lg:grid-cols-4 mb-8">
          <div className="lg:col-span-2 bg-white rounded-2xl border border-gray-200 p-6 shadow-sm">
            <h3 className="text-lg font-semibold text-gray-900 mb-4">Par√¢metros da Simula√ß√£o</h3>
            
            <div className="mb-6">
              <label className="block text-sm font-medium text-gray-700 mb-2">Valor da venda (R$)</label>
              <input
                type="number"
                min={0}
                value={valorVenda}
                onChange={(e) => setValorVenda(Number(e.target.value))}
                className="w-full rounded-xl border border-gray-300 px-4 py-3 text-lg font-semibold outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-all duration-200"
                placeholder="Ex: 20000"
              />
            </div>
            
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">Quantidade de parcelas</label>
              <div className="relative">
                <input
                  type="range"
                  min={1}
                  max={21}
                  value={parcelas}
                  onChange={(e) => setParcelas(Number(e.target.value))}
                  className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider"
                  style={{
                    background: `linear-gradient(to right, #F97316 0%, #F97316 ${((parcelas-1)/20)*100}%, #E5E7EB ${((parcelas-1)/20)*100}%, #E5E7EB 100%)`
                  }}
                />
                <div className="flex justify-between text-xs text-gray-500 mt-1">
                  <span>1x</span>
                  <span className="font-semibold text-orange-600 text-sm">{parcelas} parcela{parcelas>1?"s":""}</span>
                  <span>21x</span>
                </div>
              </div>
            </div>
          </div>

          <div className="lg:col-span-2 grid grid-cols-1 gap-4">
            <div className="bg-white rounded-2xl border border-gray-200 p-6 shadow-sm">
              <h3 className="text-sm font-medium text-gray-700 mb-3">Economia Premium vs Standard</h3>
              <div className="bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-4 border border-green-200">
                <div className="text-xs text-green-700 uppercase tracking-wide font-medium">Voc√™ economiza</div>
                <div className="text-2xl font-bold text-green-900 mt-1">{currency.format(Math.max(0, economiaPremium))}</div>
                <div className="text-xs text-green-600 mt-1">com o plano Premium</div>
              </div>
            </div>

            <div className="bg-white rounded-2xl border border-gray-200 p-6 shadow-sm">
              <button
                onClick={() => setMostrarTabela((m) => !m)}
                className="w-full bg-gradient-to-r from-orange-500 to-amber-600 hover:from-orange-600 hover:to-amber-700 text-white rounded-xl px-4 py-3 font-medium transition-all duration-200 shadow-md hover:shadow-lg"
              >
                {mostrarTabela ? "Ocultar tabela completa" : "Ver tabela completa"}
              </button>
            </div>
          </div>
        </div>

        <div className="grid grid-cols-1 gap-6 lg:grid-cols-2 mb-8">
          {linhaResumo("Standard", resultadoStandard)}
          {linhaResumo("Premium", resultadoPremium)}
        </div>

        {mostrarTabela && (
          <div className="bg-white rounded-2xl border border-gray-200 p-6 shadow-sm">
            <h3 className="text-xl font-bold text-gray-900 mb-6 text-center">Tabelas Completas de Taxas</h3>
            <div className="grid grid-cols-1 gap-8 xl:grid-cols-2">
              {tabelaPlan("Standard", taxasStandard)}
              {tabelaPlan("Premium", taxasPremium)}
            </div>
          </div>
        )}

        <div className="mt-8 bg-white rounded-2xl border border-gray-200 p-6 shadow-sm">
          <h4 className="font-semibold text-gray-900 mb-3">üìã Observa√ß√µes importantes</h4>
          <div className="text-sm text-gray-600 space-y-2">
            <p>‚Ä¢ <strong>C√°lculo:</strong> MDR aplicado sobre o valor bruto + antecipa√ß√£o aplicada sobre o valor ap√≥s desconto do MDR</p>
            <p>‚Ä¢ <strong>Taxas:</strong> Percentuais totais por quantidade de parcelas (sem capitaliza√ß√£o mensal)</p>
            <p>‚Ä¢ <strong>Simula√ß√£o:</strong> Valores aproximados, consulte a pol√≠tica vigente para informa√ß√µes definitivas</p>
            <p>‚Ä¢ <strong>Antecipa√ß√£o:</strong> Modalidade D+1 (recebimento no pr√≥ximo dia √∫til)</p>
          </div>
        </div>
      </div>
    </div>
  );
}
